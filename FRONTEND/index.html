<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DevTinder Sandbox - Fixed CORS</title>
    <style>
      body {
        font-family: sans-serif;
        background: #111;
        color: #eee;
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;
      }
      h1 {
        color: #4cafef;
        text-align: center;
        margin-bottom: 2rem;
      }
      h2 {
        margin-top: 2rem;
        color: #4cafef;
        border-bottom: 1px solid #444;
        padding-bottom: 0.5rem;
      }
      input,
      button,
      textarea {
        display: block;
        margin: 0.5rem 0;
        padding: 0.5rem;
        border-radius: 5px;
        border: none;
        width: 100%;
        box-sizing: border-box;
      }
      button {
        background: #4cafef;
        color: #fff;
        cursor: pointer;
        transition: background 0.3s;
      }
      button:hover {
        background: #3a8dc8;
      }
      pre {
        background: #222;
        padding: 1rem;
        border-radius: 5px;
        overflow-x: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      .card {
        border: 1px solid #444;
        padding: 1rem;
        margin: 0.5rem 0;
        border-radius: 8px;
        background: #1c1c1c;
      }
      .card img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        margin-right: 1rem;
        float: left;
      }
      .card h3 {
        margin-top: 0;
      }
      .section {
        background: #1a1a1a;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        border: 1px solid #333;
      }
      .row {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }
      .col {
        flex: 1;
        min-width: 300px;
      }
      .status {
        padding: 0.5rem;
        border-radius: 4px;
        margin: 0.5rem 0;
        text-align: center;
      }
      .success {
        background: #2e7d32;
        color: white;
      }
      .error {
        background: #c62828;
        color: white;
      }
      .warning {
        background: #ef6c00;
        color: white;
      }
      .debug-panel {
        background: #2a2a2a;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1.5rem;
      }
    </style>
  </head>
  <body>
    <h1>DevTinder API Sandbox ðŸš€</h1>

    <div id="statusPanel" class="status">Ready to connect...</div>

    <div class="row">
      <div class="col">
        <!-- Signup -->
        <div class="section">
          <h2>Signup</h2>
          <input id="signupEmail" placeholder="Email" />
          <input id="signupPassword" type="password" placeholder="Password" />
          <input id="signupName" placeholder="Full Name" />
          <input id="signupAge" type="number" placeholder="Age" />
          <button onclick="signup()">Sign Up</button>
        </div>

        <!-- Login / Logout -->
        <div class="section">
          <h2>Login / Logout</h2>
          <input id="loginEmail" placeholder="Email" />
          <input id="loginPassword" type="password" placeholder="Password" />
          <button onclick="login()">Login</button>
          <button onclick="logout()">Logout</button>
        </div>

        <!-- Forgot Password -->
        <div class="section">
          <h2>Forgot Password</h2>
          <input id="forgotEmail" placeholder="Email" />
          <button onclick="forgotPassword()">Send Reset Link</button>
        </div>

        <!-- Profile -->
        <div class="section">
          <h2>Profile</h2>
          <button onclick="getProfile()">Get Profile</button>
          <div id="profile"></div>
        </div>
      </div>

      <div class="col">
        <!-- Edit Profile -->
        <div class="section">
          <h2>Edit Profile</h2>
          <input id="editName" placeholder="Full Name" />
          <input id="editAge" type="number" placeholder="Age" />
          <textarea id="editAbout" placeholder="About"></textarea>
          <input id="editSkills" placeholder="Skills (comma separated)" />
          <button onclick="editProfile()">Update Profile</button>
        </div>

        <!-- Change Password -->
        <div class="section">
          <h2>Change Password</h2>
          <input id="oldPassword" type="password" placeholder="Old Password" />
          <input id="newPassword" type="password" placeholder="New Password" />
          <button onclick="changePassword()">Change Password</button>
        </div>

        <!-- Feed -->
        <div class="section">
          <h2>Feed</h2>
          <button onclick="getFeed()">Get Feed</button>
          <div id="feed"></div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <!-- Connection Requests -->
        <div class="section">
          <h2>Send Connection Requests</h2>
          <input id="targetUserId" placeholder="Target User ID" />
          <button onclick="sendRequest('interested')">Send Interested</button>
          <button onclick="sendRequest('ignored')">Send Ignored</button>
        </div>

        <div class="section">
          <h2>Review Requests</h2>
          <input id="requestId" placeholder="Request ID" />
          <button onclick="reviewRequest('accepted')">Accept</button>
          <button onclick="reviewRequest('rejected')">Reject</button>
        </div>
      </div>

      <div class="col">
        <div class="section">
          <h2>Incoming Requests</h2>
          <button onclick="getIncomingRequests()">Get Incoming Requests</button>
          <div id="incomingRequests"></div>
        </div>

        <div class="section">
          <h2>My Connections</h2>
          <button onclick="getConnections()">Get Connections</button>
          <div id="connections"></div>
        </div>
      </div>
    </div>

    <!-- Debug -->
    <div class="debug-panel">
      <h2>Debug Tools</h2>
      <button onclick="debugCookies()">Check Cookies</button>
      <button onclick="debugAuth()">Check Auth Status</button>
      <button onclick="testCORS()">Test CORS Connection</button>

      <h2>Raw Result (debug)</h2>
      <pre id="output">Waiting...</pre>
    </div>

    <script>
      const API = "https://devtinder-webapp.onrender.com";
      let authChecked = false;

      // Update status panel
      function updateStatus(message, type = "") {
        const statusPanel = document.getElementById("statusPanel");
        statusPanel.textContent = message;
        statusPanel.className = "status";
        if (type) {
          statusPanel.classList.add(type);
        }
      }

      // Core fetch helper with enhanced CORS handling
      async function api(path, options = {}) {
        updateStatus(`Calling: ${path}`, "warning");

        try {
          // Ensure we include credentials for CORS
          const config = {
            credentials: "include",
            headers: {
              "Content-Type": "application/json",
              ...(options.headers || {}),
            },
            ...options,
          };

          // For preflight handling, we might need to try both with and without credentials
          // in case the server isn't configured for credentialed requests
          if (path === "/auth/check" || path === "/profile/view") {
            // Try without credentials first for preflight
            try {
              const testRes = await fetch(API + path, {
                method: "OPTIONS",
                headers: {
                  "Access-Control-Request-Method": options.method || "GET",
                  "Access-Control-Request-Headers": "Content-Type",
                },
              });
              console.log("Preflight test:", testRes);
            } catch (e) {
              console.log("Preflight test failed, continuing anyway:", e);
            }
          }

          const res = await fetch(API + path, config);
          console.log("Response status:", res.status, res.statusText);

          // Check if response is JSON
          const contentType = res.headers.get("content-type");
          let data;

          if (contentType && contentType.includes("application/json")) {
            data = await res.json();
          } else {
            data = await res.text();
          }

          if (!res.ok) {
            throw {
              status: res.status,
              statusText: res.statusText,
              body: data,
            };
          }

          updateStatus(`Success: ${path}`, "success");
          return data;
        } catch (err) {
          console.error("API error:", err);
          updateStatus(`Error: ${err.message || "Network error"}`, "error");

          // If it's a CORS error, try a proxy approach
          if (
            (err.message && err.message.includes("CORS")) ||
            (err.message && err.message.includes("Failed to fetch"))
          ) {
            updateStatus(
              "CORS error detected. Trying fallback method...",
              "warning"
            );
            return await apiWithProxy(path, options);
          }

          return {
            error: true,
            message: err.message || "Network error",
            details: err,
          };
        }
      }

      // Fallback method using a proxy for CORS issues
      async function apiWithProxy(path, options = {}) {
        // You can set up a CORS proxy service if needed
        // For example: https://cors-anywhere.herokuapp.com/
        const PROXY_URL = ""; // Leave empty if you don't have a proxy

        if (!PROXY_URL) {
          return { error: true, message: "CORS error and no proxy configured" };
        }

        try {
          const res = await fetch(PROXY_URL + API + path, {
            headers: {
              "Content-Type": "application/json",
              ...(options.headers || {}),
            },
            ...options,
          });

          const data = await res.json();

          if (!res.ok) {
            throw {
              status: res.status,
              statusText: res.statusText,
              body: data,
            };
          }

          return data;
        } catch (err) {
          console.error("Proxy API error:", err);
          return {
            error: true,
            message: err.message || "Proxy network error",
            details: err,
          };
        }
      }

      function show(result) {
        document.getElementById("output").textContent = JSON.stringify(
          result,
          null,
          2
        );
      }

      // Debug functions
      async function debugCookies() {
        console.log("Cookies:", document.cookie);
        show({ cookies: document.cookie });
      }

      async function debugAuth() {
        const result = await api("/auth/check");
        show(result);
        return result && result.authenticated;
      }

      // Test CORS connection
      async function testCORS() {
        try {
          const response = await fetch(
            "https://devtinder-webapp.onrender.com/auth/check",
            {
              method: "OPTIONS",
              headers: {
                Origin: "https://dev-tinder-web-app-woad.vercel.app",
                "Access-Control-Request-Method": "GET",
                "Access-Control-Request-Headers": "Content-Type",
              },
            }
          );
          console.log("CORS test response:", response);
        } catch (error) {
          console.error("CORS test failed:", error);
        }
      }

      // Auth functions
      async function signup() {
        const data = {
          email: signupEmail.value,
          password: signupPassword.value,
          fullName: signupName.value,
          age: parseInt(signupAge.value),
        };
        show(
          await api("/auth/sign-up", {
            method: "POST",
            body: JSON.stringify(data),
          })
        );
      }

      async function login() {
        const data = { email: loginEmail.value, password: loginPassword.value };
        const result = await api("/auth/login", {
          method: "POST",
          body: JSON.stringify(data),
        });
        show(result);

        // If login successful, check auth status
        if (result && !result.error) {
          setTimeout(debugAuth, 1000);
        }
      }

      async function logout() {
        show(await api("/auth/logout", { method: "POST" }));
      }

      async function forgotPassword() {
        const email = forgotEmail.value;
        show(
          await api("/auth/edit/password", {
            method: "POST",
            body: JSON.stringify({ email }),
          })
        );
      }

      // Profile functions
      async function getProfile() {
        const res = await api("/profile/view");
        console.log(res);
        show(res);
        if (res?.data) {
          const p = res.data;
          profile.innerHTML = `<div class="card">
        <img src="${
          p.photoURL ||
          "https://cdn1.iconfinder.com/data/icons/user-pictures/100/unknown-512.png"
        }" />
        <h3>${p.firstName || ""} ${p.lastName || ""}</h3>
        <p>Email: ${p.email || ""}</p>
        <p>Age: ${p.age || ""}</p>
        <p>About: ${p.about || ""}</p>
        <p>Skills: ${(p.skills || []).join(", ")}</p>
      </div>`;
        }
      }

      async function editProfile() {
        const data = {
          fullName: editName.value,
          age: parseInt(editAge.value),
          about: editAbout.value,
          skills: editSkills.value.split(",").map((s) => s.trim()),
        };
        show(
          await api("/profile/edit", {
            method: "PUT",
            body: JSON.stringify(data),
          })
        );
      }

      async function changePassword() {
        const data = {
          oldPassword: oldPassword.value,
          newPassword: newPassword.value,
        };
        show(
          await api("/profile/edit/password", {
            method: "PATCH",
            body: JSON.stringify(data),
          })
        );
      }

      // Feed
      async function getFeed() {
        const res = await api("/user/feed");
        show(res);
        if (res?.data) {
          feed.innerHTML = res.data
            .map(
              (post) => `
        <div class="card">
          <img src="${post.photoURL}" />
          <h3>${post.firstName} ${post.lastName}</h3>
          <p>${post.about}</p>
          <small>Skills: ${post.skills.join(", ")}</small>
        </div>`
            )
            .join("");
        }
      }

      // Requests
      async function sendRequest(status) {
        const targetUserId = targetUserId.value;
        if (!targetUserId) return alert("Enter Target User ID");
        show(
          await api(`/request/send/${status}/${targetUserId}`, {
            method: "POST",
          })
        );
      }

      async function reviewRequest(status) {
        const requestId = document.getElementById("requestId").value;
        if (!requestId) return alert("Enter Request ID");
        show(
          await api(`/request/review/${status}/${requestId}`, {
            method: "POST",
          })
        );
      }

      async function getIncomingRequests() {
        const res = await api("/user/requests/received");
        const requests = res.data || [];
        const container = document.getElementById("incomingRequests");
        if (!requests.length) {
          container.innerHTML = "<p>No incoming requests</p>";
          return;
        }
        container.innerHTML = requests
          .map(
            (req) => `
      <div class="card">
        <strong>${req.fromUserID.fullName || req.fromUserID.firstName} ${
              req.fromUserID.lastName || ""
            }</strong>
        (${req.fromUserID.skills?.join(", ") || "No skills"})
        <p>${req.fromUserID.about || ""}</p>
        <small>Request ID: ${req._id}</small><br/>
        <button onclick="reviewRequestAndRefresh('accepted','${
          req._id
        }')">Accept</button>
        <button onclick="reviewRequestAndRefresh('rejected','${
          req._id
        }')">Reject</button>
      </div>`
          )
          .join("");
      }

      async function reviewRequestAndRefresh(status, requestId) {
        document.getElementById("requestId").value = requestId;
        await reviewRequest(status);
        await getIncomingRequests();
      }

      // Connections
      async function getConnections() {
        const res = await api("/user/connections");
        show(res);
        console.log(res);
        if (res?.data) {
          document.getElementById("connections").innerHTML = res.data
            .map(
              (u) => `
        <div class="card">
          <strong>${u.firstName} ${u.lastName}</strong>
          <p>${u.email || ""}</p>
          <img src="${u.photoURL || ""}" />
          <p>Skills: ${(u.skills || []).join(", ")}</p>
          <p>About: ${u.about || ""}</p>
        </div>`
            )
            .join("");
        }
      }
    </script>
  </body>
</html>
<!-- v2 -->